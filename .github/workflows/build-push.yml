name: Build and Push Docker Images to Personal ghcr.io

on:
  push:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: SecurityTrip
          password: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Build and push Docker images
        run: |
          # Проходим по всем директориям, содержащим Dockerfile
          for dir in $(find . -name 'Dockerfile' -exec dirname {} \;); do
            # Получаем имя директории и приводим его к нижнему регистру
            image_name=$(basename "$dir" | tr '[:upper:]' '[:lower:]')
            
            # Формируем полный тег образа
            full_tag="ghcr.io/SecurityTrip/$image_name:latest"
            
            # Выводим отладочную информацию
            echo "Обработка директории: $dir"
            echo "Сформированное имя образа: $image_name"
            echo "Полный тег: $full_tag"
            
            # Выполняем сборку и отправку образа
            docker build -t "$full_tag" "$dir"
            docker push "$full_tag"
          done
